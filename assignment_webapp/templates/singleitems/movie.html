{% include 'top.html' %}
<div class="content">
    <div class="container details">
        <!-- Check if We have a valid Movie -->
        {% if movie | length > 0 %}
            <h2 class="title"> {{movie[0].movie_title}} ({{movie[0].release_year}})</h2>
            <hr/>
            <div>
            <video id="myMovie" width="320" height="240" controls>
              <source src={{movie[0].storage_location}} type="video/mp4">
              Your browser does not support the video tag.
            </video>
            {% if movie_playback | length > 0 %}
              <p>Full Listens: {{movie_playback[0].play_count}} <br/>
                Last Listened: {{movie_playback[0].lastviewed}} <br/><br/>
                Play from where you last left off!</p>
              <button onclick="setFromLastPlayed({{movie_playback[0].progress}})" type="button">Resume</button><br>
            {% endif %}
            </div>
            <h3> Artworks </h3>
            {% for instance in movie %}
                {% if instance.md_type_name == 'artwork' %}
                    <img src="{{instance.md_value}}" alt="image">
                    <br/>Â© Amazon Public Domain 2019.
                {% endif %}
            {% endfor %}
            <br/>
            <h3> Descriptions </h3>
            {% for instance in movie %}
                {% if instance.md_type_name == 'description' %}
                    <div>
                        {{instance.md_value}}
                    </div>
                {% endif %}
            {% endfor %}
            <!-- TODO - Query (10)
            You will have to modify the approach below slightly to make each genre clickable
            -->
            <h3> Genres </h3>
            <div>
            {% for instance in movie %}
                {% if instance.md_type_name == 'film genre' %}
                <button class="clickable-tr" data-href="{{ url_for('single_genre', genre_id=instance.md_id)}}">
                  {{instance.md_value}}
                </button>
                {% endif %}
            {% endfor %}
            </div>
        {% else %}
            <h2 class="title"> Invalid Movie ID</h2>
        {% endif %}

    </div>
</div>
<script>
  var movie = document.getElementById("myMovie");

  function setFromLastPlayed(progress) {
    var last_played = (movie.duration*progress)/100;
    movie.currentTime=last_played;
  }
</script>
<script>
  movie.addEventListener('pause', (event) => {
    var pausedTime = (movie.currentTime/movie.duration)*100
    var entry = {
          media_id: {{movie[0].media_id}},
          progress: pausedTime
    }

    if(pausedTime<100) {
      fetch(`${window.origin}/update_media_progress`, {
      method: "POST",
      credentials: "include",
      body: JSON.stringify(entry),
      cache: "no-cache",
      headers: new Headers({
        "content-type": "application/json"
      })
      })
      .then(function(response) {
      if (response.status !== 200) {
        console.log(`Looks like there was a problem. Status code: ${response.status}`);
        return;
      }
      response.json().then(function(data) {
        console.log(data);
      });
      })
      .catch(function(error) {
      console.log("Fetch error: " + error);
      });
    }

  });
</script>
<script>
  movie.addEventListener("ended", function() {

      var ended_entry = {
            media_id: {{movie[0].media_id}},
      }

      fetch(`${window.origin}/update_play_count`, {
      method: "POST",
      credentials: "include",
      body: JSON.stringify(ended_entry),
      cache: "no-cache",
      headers: new Headers({
        "content-type": "application/json"
      })
      })
      .then(function(response) {
      if (response.status !== 200) {
        console.log(`Looks like there was a problem. Status code: ${response.status}`);
        return;
      }
      response.json().then(function(data) {
        console.log(data);
      });
      })
      .catch(function(error) {
      console.log("Fetch error: " + error);
    });

  });
</script>
{% include 'bottom.html'%}
