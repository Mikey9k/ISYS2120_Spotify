{% include 'top.html' %}
<div class="content">
    <div class="container details">
        <!-- Check if We have a valid song -->
        {% if song | length > 0 %}
            <h2 class="title"> {{song[0].Song_Title}} by {{song[0].Artist}}</h2>
            <br/>
            Song is {{song[0].Song_Length}} seconds long.
            <hr/>
            <h3> Listen to this song now! </h3>
            <div>
                <audio id="mySong" controls>
                <source src={{song[0].Storage_Location}} type="audio/mp3">
                Your browser does not support the audio element.
                </audio>
                <!-- Make this part conditional on if passed variable is true -->
                {% if song_playback | length > 0 %}
                  <p>Full Listens: {{song_playback[0].play_count}} <br/>
                    Last Listened: {{song_playback[0].lastviewed}} <br/><br/>
                    Play from where you last left off!</p>
                  <button onclick="setFromLastPlayed({{song_playback[0].progress}})" type="button">Resume</button><br>
                {% endif %}
            </div>
            <h3> Artworks </h3>
            {% for instance in songmetadata %}
                {% if instance.md_type_name == 'artwork' %}
                    <img src="{{instance.md_value}}" alt="image">
                    <br/>Â© Spotify Public Domain 2019.
                {% endif %}
            {% endfor %}
            <br/>
            <h3> Descriptions </h3>
            {% for instance in songmetadata %}
                {% if instance.md_type_name == 'description' %}
                    <div>
                        {{instance.md_value}}
                    </div>
                {% endif %}
            {% endfor %}
            <br/>
            <!-- TODO - Query 10
            You will have to modify the approach below slightly to make each genre clickable
            -->
            <h3> Genres </h3>
            <div>
            {% for instance in songmetadata %}
                {% if instance.md_type_name == 'song genre' %}
                    <button class="clickable-tr" data-href="{{ url_for('single_genre', genre_id=instance.md_id)}}">
                  {{instance.md_value}}
                </button>
                  {% endif %}

            {% endfor %}
            </div>
        {% else %}
            <h2 class="title"> Invalid Song ID</h2>
        {% endif %}
    </div>
</div>
<script>
  var song = document.getElementById("mySong");

  function setFromLastPlayed(progress) {
    var last_played = (song.duration*progress)/100;
    song.currentTime=last_played;
  }
</script>
<script>
  song.addEventListener('pause', (event) => {
    var pausedTime = (song.currentTime/song.duration)*100
    var entry = {
          media_id: {{song[0].song_id}},
          progress: pausedTime
    }


    if(pausedTime<100) {
      fetch(`${window.origin}/update_media_progress`, {
      method: "POST",
      credentials: "include",
      body: JSON.stringify(entry),
      cache: "no-cache",
      headers: new Headers({
        "content-type": "application/json"
      })
      })
      .then(function(response) {
      if (response.status !== 200) {
        console.log(`Looks like there was a problem. Status code: ${response.status}`);
        return;
      }
      response.json().then(function(data) {
        console.log(data);
      });
      })
      .catch(function(error) {
      console.log("Fetch error: " + error);
      });
    }

  });
</script>
<script>
  song.addEventListener("ended", function() {

      var ended_entry = {
            media_id: {{song[0].song_id}},
      }

      fetch(`${window.origin}/update_play_count`, {
      method: "POST",
      credentials: "include",
      body: JSON.stringify(ended_entry),
      cache: "no-cache",
      headers: new Headers({
        "content-type": "application/json"
      })
      })
      .then(function(response) {
      if (response.status !== 200) {
        console.log(`Looks like there was a problem. Status code: ${response.status}`);
        return;
      }
      response.json().then(function(data) {
        console.log(data);
      });
      })
      .catch(function(error) {
      console.log("Fetch error: " + error);
    });

  });
</script>
{% include 'bottom.html'%}
